<%
  def discover_external_ip
    networks = spec.networks.marshal_dump

    _, network = networks.find do |_name, network_spec|
      network_spec.default
    end

    if !network
      _, network = networks.first
    end

    if !network
      raise "Could not determine IP via network spec: #{networks}"
    end

    network.ip
  end
%>

check process bits_service
  with pidfile /var/vcap/sys/run/bits_service/bits_service.pid
  start program "/var/vcap/jobs/bits_service/bin/cloud_controller_ctl start" 
  stop program "/var/vcap/jobs/bits_service/bin/cloud_controller_ctl stop"
  group vcap

  if totalmem > <%= p("cc.thresholds.api.alert_if_above_mb") %> Mb for 3 cycles then alert
  if totalmem > <%= p("cc.thresholds.api.restart_if_consistently_above_mb") %> Mb for 15 cycles then exec "/var/vcap/jobs/bits_service/bin/restart_drain"
  if totalmem > <%= p("cc.thresholds.api.restart_if_above_mb") %> Mb for 3 cycles then exec "/var/vcap/jobs/bits_service/bin/restart_drain"
  if failed host <%= discover_external_ip %> port <%= p("cc.external_port") %> protocol http
      and request '/v2/info'
      with timeout 60 seconds for 5 cycles
  then restart
